<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Interactif Get Next Line (GNL)</title>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@400;500;600&display=swap');

        /* --- Variables de Couleur (Thème "Cyberpunk") --- */
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --border-color: #30363d;
            --text-main: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-primary: #58a6ff;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-purple: #bc8cff;
            --font-body: 'Inter', sans-serif;
            --font-code: 'Fira Code', monospace;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* --- Style Général --- */
        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 2rem;
        }

        /* --- Layout Principal (3 colonnes) --- */
        .main-container {
            display: grid;
            /* CHANGEMENT: La 3ème colonne est plus large et a une largeur minimale garantie */
            grid-template-columns: 300px 1fr minmax(650px, 1.5fr);
            gap: 1.5rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* --- Style des "Cartes" --- */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-main);
        }

        /* --- Colonne de Gauche : Panneau de Contrôle --- */
        #control-panel label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        #control-panel textarea, #control-panel input {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 6px;
            font-family: var(--font-code);
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #control-panel textarea:focus, #control-panel input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        #control-panel textarea {
            min-height: 150px;
            resize: vertical;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .presets button {
            background-color: #21262d;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        .presets button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .main-buttons {
            margin-top: auto; /* Pousse les boutons en bas */
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        button {
            padding: 0.75rem;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        #btn-gnl {
            background-color: var(--accent-primary);
            color: var(--bg-color);
        }
        #btn-gnl:hover {
            background-color: #79c0ff;
        }
        #btn-gnl:disabled {
            background-color: #21262d;
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        #btn-reset {
            background-color: #30363d;
            color: var(--text-main);
        }
        #btn-reset:hover {
            background-color: #484f58;
        }

        /* --- Colonne Centrale : Visualisation --- */
        .visual-box {
            background-color: #010409;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 0.5rem;
            min-height: 80px;
            font-family: var(--font-code);
            white-space: pre-wrap;
            word-break: break-all;
            transition: all 0.3s;
            position: relative;
        }
        .visual-box-title {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .visual-box pre {
            margin: 0;
            padding: 0;
            font-size: 1.1rem;
        }
        #file-display-box .cursor {
            width: 2px;
            height: 1.2em;
            background-color: var(--accent-red);
            display: inline-block;
            vertical-align: middle;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: var(--accent-red); }
        }

        /* --- Styles pour les animations de caractères --- */
        .char {
            display: inline-block;
            transition: all 0.3s ease-out;
            border-radius: 3px;
        }
        .char.read {
            background-color: var(--accent-yellow);
            color: var(--bg-color);
            transform: scale(1.2);
        }
        .char.stash {
            background-color: var(--accent-purple);
            color: var(--bg-color);
        }
        .char.returned {
            background-color: var(--accent-green);
            color: var(--bg-color);
        }
        .char.nl {
            background-color: rgba(88, 166, 255, 0.2);
        }
        .char.faded {
            opacity: 0.3;
        }
        #result-display.null {
            color: var(--accent-red);
            font-style: italic;
        }

        /* --- Colonne de Droite : Code & Journal --- */
        #code-display pre {
            background-color: #010409;
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin: 0;
            counter-reset: line;
            /* CHANGEMENT: Ajout de ces deux lignes pour garantir un affichage correct du code */
            white-space: pre;
            overflow-x: auto;
        }
        #code-display code span {
            display: block;
            padding: 0.1rem 0.5rem;
            margin: 0 -0.5rem;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        #code-display code span::before {
            counter-increment: line;
            content: counter(line);
            display: inline-block;
            width: 2em;
            text-align: right;
            margin-right: 1em;
            color: var(--text-secondary);
        }
        #code-display .active-line {
            background-color: rgba(88, 166, 255, 0.2);
        }
        #code-display .comment { color: var(--text-secondary); }
        #code-display .keyword { color: var(--accent-red); }
        #code-display .type { color: var(--accent-purple); }
        #code-display .function { color: var(--accent-primary); }
        #code-display .literal { color: var(--accent-green); }

        #log-box {
            margin-top: 1.5rem;
            flex-grow: 1; /* Prend l'espace restant */
        }
        #log-messages {
            background-color: #010409;
            border-radius: 6px;
            padding: 1rem;
            height: 250px;
            overflow-y: auto;
            font-family: var(--font-code);
            font-size: 0.9rem;
        }
        .log-entry {
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            gap: 0.75rem;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-icon {
            flex-shrink: 0;
        }
        .log-entry.info { color: var(--text-secondary); }
        .log-entry.read { color: var(--accent-yellow); }
        .log-entry.process { color: var(--accent-purple); }
        .log-entry.success { color: var(--accent-green); }
        .log-entry.error { color: var(--accent-red); }
        
        /* --- Responsive Design --- */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 300px 1fr;
            }
            #code-log-panel {
                grid-column: 1 / -1; /* Prend toute la largeur */
            }
        }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .main-container {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>

    <main class="main-container">

        <!-- COLONNE 1: CONTRÔLES -->
        <section id="control-panel" class="card">
            <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent-primary);"><path d="M12 2a1 1 0 0 1 1 1v2.5a1 1 0 0 1-2 0V3a1 1 0 0 1 1-1zM7.05 6.05a1 1 0 0 1 1.414-1.414l1.768 1.768a1 1 0 1 1-1.414 1.414L7.05 6.05zm9.9 0a1 1 0 0 1 1.414 1.414l-1.768 1.768a1 1 0 1 1-1.414-1.414l1.768-1.768zM3 12a1 1 0 0 1 1-1h2.5a1 1 0 0 1 0 2H4a1 1 0 0 1-1-1zm15.5 1a1 1 0 0 1 0-2H21a1 1 0 0 1 0 2h-2.5zM7.05 17.95a1 1 0 0 1-1.414-1.414l1.768-1.768a1 1 0 0 1 1.414 1.414l-1.768 1.768zm9.9 0a1 1 0 0 1-1.414 1.414l-1.768-1.768a1 1 0 1 1 1.414-1.414l1.768 1.768zM12 22a1 1 0 0 1-1-1v-2.5a1 1 0 0 1 2 0V21a1 1 0 0 1-1-1zM12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm0 2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
                <h2 class="card-title">Panneau de Contrôle</h2>
            </div>

            <div class="control-group">
                <label for="text-content">Contenu du Fichier</label>
                <textarea id="text-content"></textarea>
            </div>

            <div class="control-group">
                <label for="buffer-size">BUFFER_SIZE</label>
                <input type="number" id="buffer-size" value="10" min="1">
            </div>
            
            <div class="control-group">
                 <label>Scénarios Prédéfinis</label>
                 <div class="presets">
                    <button data-scenario="classic">Classique</button>
                    <button data-scenario="small_buffer">Petit Buffer</button>
                    <button data-scenario="no_newline">Sans `\n`</button>
                    <button data-scenario="empty">Fichier Vide</button>
                 </div>
            </div>

            <div class="main-buttons">
                <button id="btn-gnl">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2h12.172z"/></svg>
                    Prochain Appel GNL
                </button>
                <button id="btn-reset">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2zm0 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16zm-1 3a1 1 0 0 1 2 0v5.414l3.707 3.707-1.414 1.414L11 13.828V7z"/></svg>
                    Réinitialiser
                </button>
            </div>
        </section>

        <!-- COLONNE 2: VISUALISATION -->
        <section id="visual-panel" class="card">
             <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent-yellow);"><path d="M12 3c-4.963 0-9 4.037-9 9s4.037 9 9 9 9-4.037 9-9-4.037-9-9-9zm0 16c-3.859 0-7-3.141-7-7s3.141-7 7-7 7 3.141 7 7-3.141 7-7 7zM14 7l-4 4h3v6h2V9h3l-4-2z"/></svg>
                <h2 class="card-title">Flux de Données</h2>
            </div>
            <div>
                <p class="visual-box-title">1. Fichier (source de données)</p>
                <div class="visual-box" id="file-display-box">
                    <pre id="file-display"></pre>
                </div>
            </div>
             <div>
                <p class="visual-box-title">2. Stash (variable <code>static</code> - la mémoire de GNL)</p>
                <div class="visual-box">
                    <pre id="stash-display"></pre>
                </div>
            </div>
             <div>
                <p class="visual-box-title">3. Ligne Retournée (résultat de l'appel)</p>
                <div class="visual-box">
                    <pre id="result-display"></pre>
                </div>
            </div>
        </section>

        <!-- COLONNE 3: CODE & JOURNAL -->
        <section id="code-log-panel" class="card">
             <div class="card-header">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="color: var(--accent-green);"><path d="M24 12l-5.657 5.657-1.414-1.414L21.172 12l-4.243-4.243-1.414 1.414L24 12zM2.828 12l4.243 4.243 1.414-1.414L4.243 12l4.242-4.243-1.414-1.414L0 12l2.828 2.828zM9.03 21.485l-1.414-1.414L12.243 6l1.414 1.414-4.628 14.071z"/></svg>
                <h2 class="card-title">Exécution du Code & Journal</h2>
            </div>
            <div id="code-display">
                <pre><code>
<span id="code-1"><span class="type">char</span> *<span class="function">get_next_line</span>(<span class="type">int</span> fd)</span>
<span id="code-2">{</span>
<span id="code-3">    <span class="keyword">static</span> <span class="type">char</span> *stash;</span>
<span id="code-4">    <span class="type">char</span>        *line;</span>
<span id="code-5">    <span class="type">int</span>         read_bytes;</span>
<span id="code-6"></span>
<span id="code-7">    <span class="comment">// Boucle pour lire le fichier jusqu'à trouver un '\n'</span></span>
<span id="code-8">    <span class="keyword">while</span> (!<span class="function">has_newline</span>(stash))</span>
<span id="code-9">    {</span>
<span id="code-10">        <span class="comment">// ... read(fd, buffer, BUFFER_SIZE) ...</span></span>
<span id="code-11">        <span class="comment">// ... ajoute le buffer au stash ...</span></span>
<span id="code-12">        <span class="keyword">if</span> (read_bytes <= <span class="literal">0</span>) <span class="keyword">break</span>;</span>
<span id="code-13">    }</span>
<span id="code-14"></span>
<span id="code-15">    <span class="comment">// Extraire la ligne du stash</span></span>
<span id="code-16">    line = <span class="function">extract_line_from_stash</span>(&stash);</span>
<span id="code-17">    </span>
<span id="code-18">    <span class="keyword">return</span> (line);</span>
<span id="code-19">}</span>
                </code></pre>
            </div>
            <div id="log-box">
                <p class="visual-box-title" style="margin-top: 1.5rem;">Journal des Opérations</p>
                <div id="log-messages"></div>
            </div>
        </section>

    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Éléments du DOM ---
        const textContentEl = document.getElementById('text-content');
        const bufferSizeEl = document.getElementById('buffer-size');
        const btnGnl = document.getElementById('btn-gnl');
        const btnReset = document.getElementById('btn-reset');
        const fileDisplayEl = document.getElementById('file-display');
        const stashDisplayEl = document.getElementById('stash-display');
        const resultDisplayEl = document.getElementById('result-display');
        const logMessagesEl = document.getElementById('log-messages');
        const codeLines = document.querySelectorAll('#code-display code span');
        const presetButtons = document.querySelectorAll('.presets button');

        // --- Variables d'état ---
        let stash = '';
        let readOffset = 0;
        let isFinished = false;
        let gnlCallCount = 0;

        // --- Scénarios prédéfinis ---
        const scenarios = {
            classic: {
                text: "Ligne 1\nLigne 2 est plus longue.\nDernière ligne.",
                buffer: 10
            },
            small_buffer: {
                text: "abc\ndef\nghi",
                buffer: 1
            },
            no_newline: {
                text: "Un seul bloc de texte sans retour a la ligne.",
                buffer: 15
            },
            empty: {
                text: "",
                buffer: 10
            }
        };

        // --- Fonctions Utilitaires ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function highlightCodeLine(lineNumber, duration = 300) {
            codeLines.forEach(line => line.classList.remove('active-line'));
            if (lineNumber > 0 && lineNumber <= codeLines.length) {
                codeLines[lineNumber - 1].classList.add('active-line');
            }
            return sleep(duration);
        }

        function addLog(message, type = 'info') {
            const icons = {
                info: '💬', read: '🔍', process: '⚙️', success: '✅', error: '❌'
            };
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-icon">${icons[type]}</span> <div>${message}</div>`;
            logMessagesEl.appendChild(entry);
            logMessagesEl.scrollTop = logMessagesEl.scrollHeight;
        }

        function renderFileDisplay() {
            const text = textContentEl.value;
            fileDisplayEl.innerHTML = '';
            for (let i = 0; i < text.length; i++) {
                const charSpan = document.createElement('span');
                charSpan.className = 'char';
                if (text[i] === '\n') {
                    charSpan.textContent = '↵';
                    charSpan.classList.add('nl');
                } else {
                    charSpan.textContent = text[i];
                }
                if (i < readOffset) {
                    charSpan.classList.add('faded');
                }
                fileDisplayEl.appendChild(charSpan);
            }
            // Ajout du curseur
            if (readOffset < text.length) {
                const cursorSpan = document.createElement('span');
                cursorSpan.className = 'cursor';
                if (readOffset === 0) {
                    fileDisplayEl.prepend(cursorSpan);
                } else {
                    fileDisplayEl.children[readOffset-1].after(cursorSpan);
                }
            }
        }
        
        function renderStashAndResult(returnedLine, isNull = false) {
            stashDisplayEl.innerHTML = '';
            stash.split('').forEach(char => {
                const charSpan = document.createElement('span');
                charSpan.className = 'char stash';
                 if (char === '\n') {
                    charSpan.textContent = '↵';
                    charSpan.classList.add('nl');
                } else {
                    charSpan.textContent = char;
                }
                stashDisplayEl.appendChild(charSpan);
            });

            resultDisplayEl.classList.toggle('null', isNull);
            if (isNull) {
                resultDisplayEl.textContent = "NULL";
            } else {
                resultDisplayEl.innerHTML = '';
                 returnedLine.split('').forEach(char => {
                    const charSpan = document.createElement('span');
                    charSpan.className = 'char returned';
                    if (char === '\n') {
                        charSpan.textContent = '↵';
                        charSpan.classList.add('nl');
                    } else {
                        charSpan.textContent = char;
                    }
                    resultDisplayEl.appendChild(charSpan);
                });
            }
        }
        
        // --- Logique Principale ---
        async function handleGnlCall() {
            if (isFinished) {
                addLog("Le fichier est entièrement lu. Réinitialisez pour recommencer.", "error");
                return;
            }
            
            gnlCallCount++;
            btnGnl.disabled = true;
            resultDisplayEl.innerHTML = '';
            addLog(`--- Appel n°${gnlCallCount} à get_next_line ---`, 'info');
            
            await highlightCodeLine(1);
            await sleep(500);

            await highlightCodeLine(3);
            addLog("Le stash contient : " + (stash ? `"${stash.replace(/\n/g, '↵')}"` : "rien"), 'process');
            await sleep(800);

            let lineBuffer = stash;
            let newlinePos = lineBuffer.indexOf('\n');

            await highlightCodeLine(8);
            while (newlinePos === -1 && readOffset < textContentEl.value.length) {
                addLog("Pas de '\\n' dans le stash, on doit lire le fichier.", 'read');
                await sleep(500);
                
                await highlightCodeLine(10);
                const bufferSize = parseInt(bufferSizeEl.value, 10) || 1;
                const text = textContentEl.value;
                const endRead = Math.min(readOffset + bufferSize, text.length);
                const readChunk = text.substring(readOffset, endRead);
                
                addLog(`Appel à read() avec BUFFER_SIZE=${bufferSize}. Lu : "${readChunk.replace(/\n/g, '↵')}"`, 'read');

                // Animation de lecture
                for (let i = readOffset; i < endRead; i++) {
                    fileDisplayEl.children[i + (readOffset > 0)].classList.add('read');
                }
                await sleep(600);
                for (let i = readOffset; i < endRead; i++) {
                    fileDisplayEl.children[i + (readOffset > 0)].classList.remove('read');
                    fileDisplayEl.children[i + (readOffset > 0)].classList.add('faded');
                }

                readOffset = endRead;
                lineBuffer += readChunk;
                renderStashAndResult(''); // Met à jour le stash visuellement
                stash = lineBuffer; // On met à jour le vrai stash ici pour la prochaine itération
                renderFileDisplay();
                
                await highlightCodeLine(11);
                addLog(`Nouveau stash : "${lineBuffer.replace(/\n/g, '↵')}"`, 'process');
                await sleep(800);

                await highlightCodeLine(12);
                newlinePos = lineBuffer.indexOf('\n');
                await highlightCodeLine(8);
            }

            if (lineBuffer.length === 0) {
                await highlightCodeLine(18);
                addLog("Le stash est vide et le fichier est fini. On retourne NULL.", 'success');
                isFinished = true;
                renderStashAndResult('', true);
            } else if (newlinePos !== -1) {
                await highlightCodeLine(16);
                const returnedLine = lineBuffer.substring(0, newlinePos + 1);
                stash = lineBuffer.substring(newlinePos + 1);
                addLog(`'\\n' trouvé ! On extrait la ligne.`, 'success');
                await sleep(500);
                addLog(`Ligne retournée : "${returnedLine.replace(/\n/g, '↵')}"`, 'success');
                addLog(`Nouveau stash : "${stash.replace(/\n/g, '↵')}"`, 'process');
                renderStashAndResult(returnedLine);
            } else {
                await highlightCodeLine(16);
                const returnedLine = lineBuffer;
                stash = '';
                isFinished = true;
                addLog("Fin du fichier atteinte. On retourne le reste du stash.", 'success');
                await sleep(500);
                addLog(`Ligne retournée : "${returnedLine.replace(/\n/g, '↵')}"`, 'success');
                addLog(`Le stash est maintenant vide.`, 'process');
                renderStashAndResult(returnedLine);
            }
            
            await highlightCodeLine(18);
            await sleep(500);
            await highlightCodeLine(0, 0); // Clear highlight

            if (!isFinished) {
                btnGnl.disabled = false;
            }
        }

        function resetSimulation() {
            stash = '';
            readOffset = 0;
            isFinished = false;
            gnlCallCount = 0;
            btnGnl.disabled = false;

            logMessagesEl.innerHTML = '';
            addLog("Simulateur réinitialisé. Prêt pour un nouvel appel.", "info");
            
            renderFileDisplay();
            renderStashAndResult('');
            highlightCodeLine(0, 0);
        }

        function loadScenario(name) {
            const scenario = scenarios[name];
            if (scenario) {
                textContentEl.value = scenario.text;
                bufferSizeEl.value = scenario.buffer;
                resetSimulation();
            }
        }

        // --- Écouteurs d'événements ---
        btnGnl.addEventListener('click', handleGnlCall);
        btnReset.addEventListener('click', () => loadScenario('classic'));
        
        textContentEl.addEventListener('input', resetSimulation);
        bufferSizeEl.addEventListener('input', resetSimulation);
        
        presetButtons.forEach(button => {
            button.addEventListener('click', () => loadScenario(button.dataset.scenario));
        });

        // --- Initialisation ---
        loadScenario('classic');
    });
    </script>
</body>
</html>
